#!/bin/bash

echo "Post installation process started"

# Change permissions in product home
echo "Change permissions in product home"
chmod -R a+rwx /Applications/FluoRender.app/Contents/MacOS

# Function to download and install the latest Python 3 for macOS
install_python() {
    echo "Downloading latest Python 3 installer..."

    PYTHON_URL="https://www.python.org/ftp/python/3.12.3/python-3.12.3-macos11.pkg"
    curl -o python-latest.pkg "$PYTHON_URL"

    if [ $? -ne 0 ]; then
        echo "Failed to download Python installer."

        # Show GUI alert to user
        osascript -e 'display dialog "FluoRender requires Python 3, but it could not be downloaded. Please install it manually from https://www.python.org/downloads/" buttons {"OK"} default button "OK" with icon caution'

        exit 1
    fi

    echo "Installing Python 3..."
    installer -pkg python-latest.pkg -target /
    rm python-latest.pkg
}

# Check for Python 3 in common locations
PYTHON_PATHS=(
    "/usr/bin/python3"
    "/opt/homebrew/bin/python3"
    "/usr/local/bin/python3"
    "/Library/Frameworks/Python.framework/Versions/3.*/bin/python3"
)

PYTHON_FOUND=false
for path in "${PYTHON_PATHS[@]}"; do
    if ls $path &> /dev/null; then
        echo "Found Python at $path"
        PYTHON_FOUND=true
        break
    fi
done

if [ "$PYTHON_FOUND" = false ]; then
    echo "Python 3 not found. Attempting installation..."
    install_python
else
    echo "Python 3 is already installed."
fi

echo "Postinstall script completed."
