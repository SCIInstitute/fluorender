#!/bin/bash

echo "🚀 Post installation process started"

# 🔧 Adjust permissions
echo "🔒 Changing permissions in product home..."
chmod -R a+rwx "/Applications/FluoRender.app/Contents/MacOS"

# 🐍 Function to download and install Python 3.13
install_python() {
    echo "📦 Downloading Python 3.13 installer..."
    PYTHON_URL="https://www.python.org/ftp/python/3.13.0/python-3.13.0-macos11.pkg"

    if ! curl -o python-3.13.pkg "$PYTHON_URL"; then
        echo "❌ Failed to download Python installer."

        # Show GUI alert
        osascript -e 'display dialog "FluoRender requires Python 3.13, but it could not be downloaded. Please install it manually from https://www.python.org/downloads/" buttons {"OK"} default button "OK" with icon caution'

        exit 1
    fi

    echo "⚙️ Installing Python 3.13..."
    installer -pkg python-3.13.pkg -target /
    rm -f python-3.13.pkg
}

# 🧭 Check for Python binary in common locations
PYTHON_FOUND=false
for path in /Library/Frameworks/Python.framework/Versions/3*/bin/python3 \
            /usr/local/bin/python3 \
            /opt/homebrew/bin/python3 \
            /usr/bin/python3
do
    if [ -x "$path" ]; then
        echo "✅ Found Python at $path"
        PYTHON_FOUND=true
        break
    fi
done

# 🕵️ Verify framework path compatibility
if [ "$PYTHON_FOUND" = true ]; then
    CURRENT_SYMLINK=$(readlink /Library/Frameworks/Python.framework/Versions/Current 2>/dev/null)

    if [[ "$CURRENT_SYMLINK" != *"3.13"* ]]; then
        echo "⚠️ Python is installed, but 'Current' symlink does not point to 3.13"
        install_python
    else
        echo "✅ Compatible Python version detected (3.13)"
    fi
else
    echo "🚫 Python 3.13 not found. Attempting installation..."
    install_python
fi

echo "🎉 Postinstall script completed successfully."
